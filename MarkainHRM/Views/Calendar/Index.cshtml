@model IEnumerable<OzarkLMS.Models.CalendarEvent>
@using System.Text.Json

@{
    ViewData["Title"] = "Elite Planner";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var eventsJson = JsonSerializer.Serialize(Model.Select(e => new {
        id = e.Id,
        title = e.Title,
        start = e.Start,
        end = e.End,
        color = e.Color
    }));
}

<div class="p-4 md:p-8 lg:p-12 max-w-[1700px] mx-auto space-y-12 md:space-y-16">
    <!-- Executive Header -->
    <div class="relative overflow-hidden rounded-4xl bg-emerald-950 p-12 md:p-16 shadow-premium-dark">
        <!-- Dynamic 3D Waves -->
        <div class="absolute inset-0 opacity-20 pointer-events-none overflow-hidden container-waves">
            <svg class="absolute inset-0 w-full h-full" preserveAspectRatio="none" viewBox="0 0 1440 400" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="cal-wave-grad" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" stop-color="#10B981" stop-opacity="0.4" />
                        <stop offset="100%" stop-color="transparent" />
                    </linearGradient>
                </defs>
                <path class="cal-wave c-1" d="M0,200 Q360,150 720,200 T1440,200 V400 H0 Z" fill="url(#cal-wave-grad)" />
                <path class="cal-wave c-2" d="M0,250 Q360,300 720,250 T1440,250 V400 H0 Z" fill="#34D399" opacity="0.1" />
            </svg>
        </div>

        <style>
            .cal-wave { animation: cal-float 15s ease-in-out infinite alternate; }
            .c-1 { animation-duration: 18s; }
            .c-2 { animation-duration: 22s; animation-delay: -5s; }
            @@keyframes cal-float {
                from { transform: translateY(0) scaleY(1); }
                to { transform: translateY(-20px) scaleY(1.05); }
            }
        </style>
        
        <div class="relative z-10 flex flex-col md:flex-row md:items-end justify-between gap-8">
            <div class="space-y-4">
                <h1 class="text-5xl md:text-6xl font-black text-white tracking-tighter leading-none">
                    Schedule <span class="text-emerald-500">& Organization</span>
                </h1>
                <p class="text-emerald-100/40 font-medium max-w-xl">Synchronize institutional objectives and workforce scheduling.</p>
            </div>
            
            <button onclick="document.getElementById('addEventModal').showModal()" class="bg-emerald-500 text-emerald-950 px-8 py-4 rounded-2xl font-black shadow-lg shadow-emerald-500/10 transition-all hover:scale-105 active:scale-95 flex items-center gap-3 self-start md:self-auto">
                <i data-lucide="calendar-plus" class="w-5 h-5"></i>
                NEW OBJECTIVE
            </button>
        </div>
    </div>

    <!-- Controls Toolbar -->
    <div class="flex flex-col sm:flex-row items-center justify-between bg-white dark:bg-emerald-950/20 p-6 rounded-4xl border border-emerald-900/5 dark:border-emerald-50/5 shadow-premium gap-6">
        <div class="flex items-center gap-6">
            <div id="monthControls" class="flex items-center gap-6">
                <button id="prevMonthBtn" class="p-3 bg-emerald-50 dark:bg-emerald-500/10 rounded-2xl text-emerald-600 dark:text-emerald-400 hover:scale-110 transition-all">
                    <i data-lucide="chevron-left" class="w-6 h-6"></i>
                </button>
                <h2 id="currentMonthDisplay" class="text-2xl font-black text-emerald-950 dark:text-white min-w-[200px] text-center tracking-tighter"></h2>
                <button id="nextMonthBtn" class="p-3 bg-emerald-50 dark:bg-emerald-500/10 rounded-2xl text-emerald-600 dark:text-emerald-400 hover:scale-110 transition-all">
                    <i data-lucide="chevron-right" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
             <div class="flex bg-emerald-50 dark:bg-emerald-500/10 p-1.5 rounded-2xl border border-emerald-900/5 dark:border-emerald-50/5">
                <button onclick="switchView('calendar')" id="tabBtn-calendar" class="px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all bg-white dark:bg-emerald-500 text-emerald-950 shadow-md">
                    Grid View
                </button>
                <button onclick="switchView('list')" id="tabBtn-list" class="px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all text-emerald-900/40 dark:text-emerald-50/40 hover:text-emerald-900">
                    Chronology
                </button>
            </div>
        </div>
    </div>

    <!-- Calendar Grid View -->
    <div id="calendarView" class="bg-white dark:bg-emerald-950/20 rounded-4xl shadow-premium border border-emerald-900/5 dark:border-emerald-50/5 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-700">
        <div class="grid grid-cols-7 border-b border-emerald-900/5 dark:border-emerald-50/5 bg-emerald-50/30 dark:bg-emerald-950/40">
            @foreach(var day in new[]{"SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"})
            {
                <div class="py-5 text-center text-[10px] font-black text-emerald-900/40 dark:text-emerald-50/40 tracking-[0.2em]">@day</div>
            }
        </div>
        
        <div id="calendarGrid" class="grid grid-cols-7 auto-rows-fr min-h-[700px] bg-emerald-900/5 dark:bg-emerald-50/5 gap-px">
            <!-- JS populated -->
        </div>
    </div>

    <!-- List View -->
    <div id="listView" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-700">
        <div id="eventsListContent" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
            <!-- JS populated -->
        </div>
    </div>
</div>

<!-- Modals -->
<dialog id="addEventModal" class="backdrop:backdrop-blur-md backdrop:bg-emerald-950/40 rounded-4xl shadow-2xl p-0 w-full max-w-lg bg-transparent border-none">
    <div class="bg-white dark:bg-emerald-950 p-10 border border-emerald-900/10 dark:border-emerald-50/10 rounded-4xl">
        <div class="flex items-center justify-between mb-8">
            <h3 class="text-2xl font-black text-emerald-950 dark:text-white uppercase tracking-tighter">New Operational Event</h3>
            <button onclick="document.getElementById('addEventModal').close()" class="w-10 h-10 flex items-center justify-center bg-emerald-50 dark:bg-emerald-500/10 rounded-xl text-emerald-900/40 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <form asp-action="Create" method="post" class="space-y-6" onsubmit="preparePersistence()">
            <div class="space-y-2">
                <label class="text-[10px] font-black text-emerald-900/40 dark:text-emerald-50/40 uppercase tracking-widest pl-2">Objective Title</label>
                <input name="title" class="w-full bg-emerald-50 dark:bg-emerald-500/5 border-none rounded-2xl px-6 py-4 font-bold text-sm focus:ring-2 focus:ring-emerald-500 outline-none transition-all dark:text-white" placeholder="Institutional Review" required />
            </div>
            
            <div class="grid grid-cols-2 gap-6">
                <div class="space-y-2">
                     <label class="text-[10px] font-black text-emerald-900/40 dark:text-emerald-50/40 uppercase tracking-widest pl-2">Activation</label>
                     <input name="start" type="datetime-local" class="w-full bg-emerald-50 dark:bg-emerald-500/5 border-none rounded-2xl px-4 py-4 font-bold text-sm focus:ring-2 focus:ring-emerald-500 outline-none dark:text-white [&::-webkit-calendar-picker-indicator]:dark:invert" required />
                </div>
                 <div class="space-y-2">
                     <label class="text-[10px] font-black text-emerald-900/40 dark:text-emerald-50/40 uppercase tracking-widest pl-2">Completion</label>
                     <input name="end" type="datetime-local" class="w-full bg-emerald-50 dark:bg-emerald-500/5 border-none rounded-2xl px-4 py-4 font-bold text-sm focus:ring-2 focus:ring-emerald-500 outline-none dark:text-white [&::-webkit-calendar-picker-indicator]:dark:invert" />
                </div>
            </div>

            <div class="pt-4 flex gap-4">
                <button type="button" onclick="document.getElementById('addEventModal').close()" class="flex-1 bg-emerald-50 dark:bg-emerald-500/10 text-emerald-900 dark:text-emerald-50 py-4 rounded-2xl font-black transition-all">ABORT</button>
                <button type="submit" class="flex-1 bg-emerald-950 dark:bg-emerald-500 text-white dark:text-emerald-950 py-4 rounded-2xl font-black shadow-xl hover:scale-105 transition-all">ESTABLISH EVENT</button>
            </div>
        </form>
    </div>
</dialog>

<dialog id="deleteModal" class="backdrop:backdrop-blur-md backdrop:bg-emerald-950/40 rounded-4xl shadow-2xl p-0 w-full max-w-md bg-transparent border-none">
    <div class="bg-white dark:bg-emerald-950 p-10 border border-emerald-900/10 dark:border-emerald-50/10 rounded-4xl text-center">
        <div class="w-20 h-20 rounded-3xl bg-red-50 dark:bg-red-500/10 text-red-500 flex items-center justify-center mx-auto mb-8">
            <i data-lucide="trash-2" class="w-10 h-10"></i>
        </div>
        <h3 class="text-3xl font-black text-emerald-950 dark:text-white uppercase tracking-tighter mb-4">Purge Event?</h3>
        <p class="text-emerald-900/60 dark:text-emerald-50/60 font-bold text-sm mb-10">This will remove the event from all institutional schedules indefinitely.</p>
        
        <div class="grid grid-cols-2 gap-4">
            <button onclick="document.getElementById('deleteModal').close()" class="bg-emerald-50 dark:bg-emerald-500/10 text-emerald-900 dark:text-emerald-50 py-4 rounded-2xl font-black transition-all">CANCEL</button>
            <button onclick="confirmDelete()" class="bg-red-600 text-white py-4 rounded-2xl font-black shadow-xl shadow-red-600/20 hover:scale-105 transition-all">AUTHORIZE DELETE</button>
        </div>
    </div>
</dialog>

<form id="deleteForm" asp-action="Delete" method="post" class="hidden" onsubmit="preparePersistence()">
    <input type="hidden" id="deleteEventId" name="id" />
</form>

<script>
    const events = @Html.Raw(eventsJson);
    const calendarGrid = document.getElementById('calendarGrid');
    const currentMonthDisplay = document.getElementById('currentMonthDisplay');
    let currentDate = new Date();

    function renderCalendar() {
        calendarGrid.innerHTML = '';
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay();

        currentMonthDisplay.textContent = `${new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(currentDate)}`;

        // Padding
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = startDayOfWeek - 1; i >= 0; i--) {
            calendarGrid.appendChild(createDayElement(prevMonthLastDay - i, true));
        }

        // Days
        for (let day = 1; day <= daysInMonth; day++) {
             const dayEl = createDayElement(day, false);
             const dayEvents = events.filter(e => {
                 const d = new Date(e.start);
                 return d.getFullYear() === year && d.getMonth() === month && d.getDate() === day;
             });

             if (dayEvents.length > 0) {
                 const container = document.createElement('div');
                 container.className = 'mt-3 space-y-1.5';
                 dayEvents.forEach(evt => {
                     const evtEl = document.createElement('div');
                     evtEl.className = 'text-[9px] font-black p-2 rounded-xl bg-emerald-50 dark:bg-emerald-500/10 text-emerald-900 dark:text-emerald-400 uppercase tracking-widest truncate cursor-pointer hover:bg-emerald-100 transition-all flex justify-between items-center group/evt';
                     evtEl.innerHTML = `
                        <span class="truncate">${evt.title}</span>
                        <button onclick="deleteEvent(event, ${evt.id})" class="opacity-0 group-hover/evt:opacity-100 text-red-500 p-0.5">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                     `;
                     container.appendChild(evtEl);
                 });
                 dayEl.appendChild(container);
             }

             const today = new Date();
             if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                 dayEl.classList.add('bg-emerald-500/5');
                 dayEl.querySelector('.day-number').className = 'day-number w-10 h-10 flex items-center justify-center rounded-2xl text-sm font-black bg-emerald-500 text-emerald-950 shadow-lg';
             }
             calendarGrid.appendChild(dayEl);
        }

        // Fill grid
        const remaining = 42 - calendarGrid.children.length;
        for (let i = 1; i <= remaining; i++) {
             calendarGrid.appendChild(createDayElement(i, true));
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function createDayElement(dayNum, isPadding) {
        const el = document.createElement('div');
        el.className = `min-h-[120px] p-4 bg-white dark:bg-emerald-950/20 border-r border-b border-emerald-900/5 dark:border-emerald-50/5 transition-all ${isPadding ? 'opacity-20' : 'hover:bg-emerald-50/30 dark:hover:bg-emerald-500/5'}`;
        const numberEl = document.createElement('div');
        numberEl.className = `day-number w-8 h-8 flex items-center justify-center rounded-xl text-xs font-black ${isPadding ? 'text-emerald-900/20' : 'text-emerald-950 dark:text-white'}`;
        numberEl.textContent = dayNum;
        el.appendChild(numberEl);
        return el;
    }

    function switchView(viewName) {
        const calView = document.getElementById('calendarView');
        const listView = document.getElementById('listView');
        const calBtn = document.getElementById('tabBtn-calendar');
        const listBtn = document.getElementById('tabBtn-list');

        if (viewName === 'calendar') {
            calView.classList.remove('hidden');
            listView.classList.add('hidden');
            calBtn.className = 'px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all bg-white dark:bg-emerald-500 text-emerald-950 shadow-md';
            listBtn.className = 'px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all text-emerald-900/40 dark:text-emerald-50/40 hover:text-emerald-900';
        } else {
            calView.classList.add('hidden');
            listView.classList.remove('hidden');
            listBtn.className = 'px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all bg-white dark:bg-emerald-500 text-emerald-950 shadow-md';
            calBtn.className = 'px-6 py-2.5 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all text-emerald-900/40 dark:text-emerald-50/40 hover:text-emerald-900';
            renderListView();
        }
    }

    function renderListView() {
        const content = document.getElementById('eventsListContent');
        content.innerHTML = '';
        if (events.length === 0) {
            content.innerHTML = '<div class="col-span-full py-32 text-center bg-white dark:bg-emerald-950/20 rounded-4xl border border-dashed border-emerald-900/10"><p class="text-emerald-900/40 font-black uppercase tracking-widest">No Chronical Data Points</p></div>';
            return;
        }
        events.sort((a,b) => new Date(a.start) - new Date(b.start)).forEach(evt => {
            const card = document.createElement('div');
            card.className = 'p-10 rounded-4xl bg-white dark:bg-emerald-950/30 border border-emerald-900/5 dark:border-emerald-50/5 shadow-premium hover:shadow-2xl transition-all group';
            card.innerHTML = `
                <div class="space-y-6">
                    <div class="flex items-start justify-between">
                        <h4 class="text-2xl font-black text-emerald-950 dark:text-white leading-tight group-hover:text-emerald-500 transition-colors uppercase tracking-tight">${evt.title}</h4>
                        <button onclick="deleteEvent(event, ${evt.id})" class="p-2 text-emerald-900/20 hover:text-red-500 transition-colors">
                            <i data-lucide="trash-2" class="w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="space-y-4 pt-4 border-t border-emerald-900/5">
                        <div class="flex items-center gap-4">
                            <i data-lucide="clock" class="w-4 h-4 text-emerald-500"></i>
                            <span class="text-[10px] font-black text-emerald-900/40 dark:text-emerald-50/40 uppercase tracking-widest">${new Date(evt.start).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `;
            content.appendChild(card);
        });
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function deleteEvent(e, id) {
        e.stopPropagation();
        document.getElementById('deleteEventId').value = id;
        document.getElementById('deleteModal').showModal();
    }
    
    function confirmDelete() {
        document.getElementById('deleteForm').submit();
    }

    document.getElementById('prevMonthBtn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
    document.getElementById('nextMonthBtn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

    renderCalendar();
</script>
