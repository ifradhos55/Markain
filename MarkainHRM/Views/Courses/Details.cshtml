@model OzarkLMS.Models.Course

@{
    var activeTab = Context.Request.Query["tab"].ToString();
    if (string.IsNullOrEmpty(activeTab)) activeTab = "home";
}

<div class="flex flex-col h-full bg-[#FAFBFC] dark:bg-slate-950 transition-colors duration-300">
    <!-- Course Header -->
    <div class="bg-white dark:bg-slate-900 border-b border-gray-200 dark:border-slate-800 px-8 py-6 mb-6 transition-colors">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                 <div class="w-12 h-12 rounded-lg bg-[#004B87] dark:bg-blue-600 text-white flex items-center justify-center text-2xl mr-4 shadow-sm">
                    @Model.Icon
                 </div>
                 <div>
                     <h1 class="text-2xl font-bold text-slate-800 dark:text-white tracking-tight leading-none">@Model.Name</h1>
                     <div class="flex items-center text-sm text-slate-500 dark:text-slate-400 mt-1">
                         <span class="font-semibold text-[#DA291C] dark:text-red-400">@Model.Code</span>
                         <span class="mx-2 text-gray-300 dark:text-slate-600">•</span>
                         <span>@Model.Term</span>
                     </div>
                 </div>
            </div>
            <div class="flex items-center space-x-3">
                 @if(Model.Enrollments != null) // Ensure populated or handle null
                 {
                    // View logic for enrolled students could go here
                 }
                 
                 @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                 {
                     <a asp-action="ManageStudents" asp-route-id="@Model.Id" class="bg-white dark:bg-slate-700 border border-[#004B87] dark:border-blue-500 text-[#004B87] dark:text-blue-300 px-4 py-2 rounded-lg font-medium text-sm hover:bg-blue-50 dark:hover:bg-slate-600 transition-colors flex items-center shadow-sm">
                         <i data-lucide="users" class="w-4 h-4 mr-2"></i> Students
                     </a>
                 }

                 <a asp-action="Index" class="text-sm font-medium text-slate-500 dark:text-slate-400 hover:text-[#004B87] dark:hover:text-blue-400 transition-colors flex items-center">
                     <i data-lucide="arrow-left" class="w-4 h-4 mr-1"></i> Back
                 </a>
            </div>
        </div>
    </div>

    <div class="flex flex-col md:flex-row flex-1 px-8 pb-8 max-w-[1400px] w-full mx-auto">
        <!-- Sidebar Navigation -->
        <nav class="w-full md:w-64 flex-shrink-0 md:mr-8 mb-6 md:mb-0">
            <ul class="space-y-1">
                <li>
                    <a href="?tab=home" class="flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all @(activeTab == "home" ? "bg-[#004B87] dark:bg-blue-700 text-white shadow-md" : "text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-800 hover:shadow-sm")">
                        <i data-lucide="home" class="w-4 h-4 mr-3"></i> Home
                    </a>
                </li>
                <li>
                    <a href="?tab=assignments" class="flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all @(activeTab == "assignments" ? "bg-[#004B87] dark:bg-blue-700 text-white shadow-md" : "text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-800 hover:shadow-sm")">
                        <i data-lucide="file-text" class="w-4 h-4 mr-3"></i> Assignments
                    </a>
                </li>
                <li>
                    <a href="?tab=quizzes" class="flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all @(activeTab == "quizzes" ? "bg-[#004B87] dark:bg-blue-700 text-white shadow-md" : "text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-800 hover:shadow-sm")">
                        <i data-lucide="check-circle" class="w-4 h-4 mr-3"></i> Quizzes
                    </a>
                </li>
                <li>
                    <a href="?tab=meetings" class="flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all @(activeTab == "meetings" ? "bg-[#004B87] dark:bg-blue-700 text-white shadow-md" : "text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-800 hover:shadow-sm")">
                        <i data-lucide="video" class="w-4 h-4 mr-3"></i> Meetings
                    </a>
                </li>
                <li>
                    <a href="?tab=grades" class="flex items-center px-4 py-2.5 rounded-lg text-sm font-medium transition-all @(activeTab == "grades" ? "bg-[#004B87] dark:bg-blue-700 text-white shadow-md" : "text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-900 hover:shadow-sm")">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 mr-3"></i> Grades
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 bg-white dark:bg-slate-900 rounded-xl shadow-sm border border-gray-200 dark:border-slate-800 min-h-[500px] p-8 transition-colors">
            
            @if(activeTab == "home")
            {
                <div class="space-y-8">
   <div class="pb-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-end">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">Course Content</h2>
                        @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                        {
                            <a asp-controller="Assignments" asp-action="Create" asp-route-courseId="@Model.Id" class="text-xs bg-blue-50 dark:bg-blue-900/30 text-[#004B87] dark:text-blue-300 px-3 py-1 rounded-full font-bold hover:bg-blue-100 dark:hover:bg-blue-800 transition-colors">
                                + Add Content
                            </a>
                        }
                    </div>

                    @if(Model.Modules.Any())
                    {
                        foreach(var module in Model.Modules)
                        {
                            <div class="border border-gray-200 dark:border-slate-800 rounded-lg overflow-hidden shadow-sm mb-4">
                                <div class="bg-gray-50 dark:bg-slate-950 px-5 py-3 border-b border-gray-200 dark:border-slate-800 flex items-center justify-between">
                                    <h3 class="font-bold text-slate-700 dark:text-slate-300 text-sm uppercase tracking-wide">@module.Title</h3>
                                    <div class="flex items-center space-x-2">
                                        @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                                        {
                                            <a asp-controller="Modules" asp-action="AddItem" asp-route-moduleId="@module.Id" class="text-xs text-[#004B87] dark:text-blue-400 font-bold hover:underline">+ Add Item</a>
                                            <button type="button" onclick="openDeletionModal('@Url.Action("Delete", "Modules", new { id = module.Id })', 'Delete Module', 'Are you sure you want to delete this module? All items within it will also be removed.')" class="text-slate-400 hover:text-red-500 transition-colors">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                            </button>
                                        }
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                                    </div>
                                </div>
                                <div class="divide-y divide-gray-100 dark:divide-slate-800 bg-white dark:bg-slate-900">
                                    @foreach(var item in module.Items)
                                    {
                                        <div class="px-5 py-3 border-l-4 border-transparent hover:border-[#004B87] dark:hover:border-blue-500 transition-colors bg-white dark:bg-slate-900">
                                            @if(item.DisplayMode == "embed" && !string.IsNullOrEmpty(item.ContentUrl))
                                            {
                                                <div class="mb-2 flex items-center text-[#004B87] dark:text-blue-300 font-bold">
                                                    <i data-lucide="file" class="w-4 h-4 mr-2"></i> @item.Title
                                                </div>
                                                <div class="w-full aspect-video rounded-lg overflow-hidden border border-gray-200 dark:border-slate-700 bg-gray-100 dark:bg-slate-900">
                                                    <!-- Simple embed fallback for PDF/Images. For production, consider a PDF viewer lib -->
                                                    <iframe src="@item.ContentUrl" class="w-full h-full"></iframe>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="flex items-center hover:bg-blue-50/50 dark:hover:bg-slate-700/50 -mx-5 px-5 py-2 transition-colors group cursor-pointer">
                                                    <div class="text-slate-300 dark:text-slate-500 mr-4 group-hover:text-[#DA291C] dark:group-hover:text-red-400 transition-colors">
                                                        <i data-lucide="@(item.Type == "file" ? "file" : (item.Type == "quiz" ? "help-circle" : "file-text"))" class="w-4 h-4"></i>
                                                    </div>
                                                    @if(!string.IsNullOrEmpty(item.ContentUrl))
                                                    {
                                                        <a href="@item.ContentUrl" target="_blank" class="text-sm font-medium text-slate-700 dark:text-slate-300 group-hover:text-[#004B87] dark:group-hover:text-blue-300 hover:underline">@item.Title</a>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-sm font-medium text-slate-700 dark:text-slate-300 group-hover:text-[#004B87] dark:group-hover:text-blue-300">@item.Title</span>
                                                    }

                                                    @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                                                    {
                                                        <div class="ml-auto opacity-0 group-hover:opacity-100 transition-opacity flex items-center space-x-2">
                                                            <button type="button" onclick="openDeletionModal('@Url.Action("DeleteItem", "Modules", new { id = item.Id })', 'Delete Item', 'Are you sure you want to delete this module item?')" class="text-slate-400 hover:text-red-500 transition-colors">
                                                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                                            </button>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                         <div class="text-center py-20 border-2 border-dashed border-gray-100 dark:border-slate-700 rounded-xl bg-gray-50/50 dark:bg-slate-800/30">
                            <p class="text-slate-400 dark:text-slate-500 mb-4 font-medium">This course has no modules yet.</p>
                        </div>
                    }
                    
                    @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                    {
                        <div class="mt-6 text-center">
                            <a asp-controller="Modules" asp-action="Create" asp-route-courseId="@Model.Id" class="bg-white dark:bg-slate-700 border border-gray-200 dark:border-slate-600 text-slate-500 dark:text-slate-300 px-4 py-2 rounded-lg font-bold text-sm hover:border-[#004B87] dark:hover:border-blue-400 hover:text-[#004B87] dark:hover:text-blue-400 transition-all">
                                + Create New Module
                            </a>
                        </div>
                    }
                </div>
            }
            else if (activeTab == "assignments")
            {
                 <div class="space-y-6">
                     <div class="pb-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">Assignments</h2>
                        @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                        {
                             <div class="flex space-x-2">
                                 <a asp-controller="Assignments" asp-action="Create" asp-route-courseId="@Model.Id" asp-route-type="assignment" class="bg-[#004B87] dark:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md hover:bg-[#003d6e] dark:hover:bg-blue-700 flex items-center transition-all">
                                     <i data-lucide="file-plus" class="w-4 h-4 mr-2"></i> Create Assignment
                                 </a>
                             </div>
                        }
                     </div>

                     <div class="overflow-hidden border border-gray-200 dark:border-slate-700 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                            <thead class="bg-gray-50 dark:bg-slate-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Assignment</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Due Date</th>
                                    @if (User.IsInRole("student"))
                                    {
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Score</th>
                                    }
                                    else
                                    {
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Submissions</th>
                                    }
                                    <th scope="col" class="relative px-6 py-3">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-700">
                                @foreach(var item in Model.Assignments.Where(a => a.Type != "quiz"))
                                {
                                    <tr class="hover:bg-gray-50 dark:hover:bg-slate-800/50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 dark:bg-blue-900/30 rounded-lg flex items-center justify-center text-[#004B87] dark:text-blue-300">
                                                    <i data-lucide="file-text" class="w-5 h-5"></i>
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900 dark:text-white">@item.Title</div>
                                                    <div class="text-xs text-gray-500 dark:text-slate-400">Attempts: @item.MaxAttempts</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900 dark:text-slate-300">@item.DueDate.ToString("MMM dd, yyyy")</div>
                                            <div class="text-xs text-gray-500 dark:text-slate-500">@item.DueDate.ToString("h:mm tt")</div>
                                        </td>
                                        @if (User.IsInRole("student"))
                                        {
                                            var submission = (ViewBag.StudentSubmissions as List<OzarkLMS.Models.Submission>)?.FirstOrDefault(s => s.AssignmentId == item.Id);
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                @if (submission != null)
                                                {
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                                        Submitted
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-slate-700 dark:text-slate-300">
                                                        Not Submitted
                                                    </span>
                                                }
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-400">
                                                @if (submission != null && submission.Score.HasValue)
                                                {
                                                    var percentage = item.Points > 0 ? (double)submission.Score.Value / item.Points * 100 : 0;
                                                    <span class="font-bold @(percentage >= 60 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                                                        @Math.Round(percentage, 1)%
                                                    </span>
                                                    <span class="text-xs text-gray-400">(@submission.Score/@item.Points)</span>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <a asp-controller="Assignments" asp-action="Take" asp-route-id="@item.Id" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300">
                                                    @(submission != null ? "View" : "Start")
                                                </a>
                                            </td>
                                        }
                                        else
                                        {
                                            // Admin/Instructor View
                                            var submissionCount = (ViewBag.AllSubmissions as List<OzarkLMS.Models.Submission>)?.Count(s => s.AssignmentId == item.Id) ?? 0;
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-400">
                                                @submissionCount Submissions
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                                <a asp-controller="Assignments" asp-action="Submissions" asp-route-id="@item.Id" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300">Grade</a>
                                                <a asp-controller="Assignments" asp-action="Edit" asp-route-id="@item.Id" class="text-gray-600 dark:text-slate-400 hover:text-gray-900 dark:hover:text-slate-200">Edit</a>
                                                <button type="button" onclick="openDeletionModal('@Url.Action("Delete", "Assignments", new { id = item.Id })', 'Delete Assignment', 'Are you sure you want to delete this assignment? This will also remove all student submissions.')" class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300">
                                                    <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                                </button>
                                            </td>
                                        }
                                    </tr>
                                }
                                @if(!Model.Assignments.Any(a => a.Type != "quiz"))
                                {
                                    <tr>
                                        <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500 dark:text-slate-400">
                                            No assignments found for this course.
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                     </div>
                 </div>
            }
            else if (activeTab == "quizzes")
            {
                 <div class="space-y-6">
                     <div class="pb-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">Quizzes</h2>
                        @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                        {
                             <div class="flex space-x-2">
                                 <a asp-controller="Assignments" asp-action="Create" asp-route-courseId="@Model.Id" asp-route-type="quiz" class="bg-[#D14900] dark:bg-orange-700 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md hover:bg-[#a33900] dark:hover:bg-orange-800 flex items-center transition-all">
                                     <i data-lucide="help-circle" class="w-4 h-4 mr-2"></i> Create Quiz
                                 </a>
                             </div>
                        }
                     </div>

                     <div class="overflow-hidden border border-gray-200 dark:border-slate-700 sm:rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-slate-700">
                            <thead class="bg-gray-50 dark:bg-slate-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Quiz</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Due Date</th>
                                    @if (User.IsInRole("student"))
                                    {
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Status</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Score</th>
                                    }
                                    else
                                    {
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-slate-400 uppercase tracking-wider">Submissions</th>
                                    }
                                    <th scope="col" class="relative px-6 py-3">
                                        <span class="sr-only">Actions</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-slate-900 divide-y divide-gray-200 dark:divide-slate-700">
                                @foreach(var item in Model.Assignments.Where(a => a.Type == "quiz"))
                                {
                                    <tr class="hover:bg-gray-50 dark:hover:bg-slate-800/50 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center text-purple-600 dark:text-purple-300">
                                                    <i data-lucide="help-circle" class="w-5 h-5"></i>
                                                </div>
                                                <div class="ml-4">
                                                    <div class="text-sm font-medium text-gray-900 dark:text-white">@item.Title</div>
                                                    <div class="text-xs text-gray-500 dark:text-slate-400">Attempts: @item.MaxAttempts</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm text-gray-900 dark:text-slate-300">@item.DueDate.ToString("MMM dd, yyyy")</div>
                                            <div class="text-xs text-gray-500 dark:text-slate-500">@item.DueDate.ToString("h:mm tt")</div>
                                        </td>
                                        @if (User.IsInRole("student"))
                                        {
                                            var submission = (ViewBag.StudentSubmissions as List<OzarkLMS.Models.Submission>)?.FirstOrDefault(s => s.AssignmentId == item.Id);
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                @if (submission != null)
                                                {
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                                        Submitted
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-slate-700 dark:text-slate-300">
                                                        Not Submitted
                                                    </span>
                                                }
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-400">
                                                @if (submission != null && submission.Score.HasValue)
                                                {
                                                    var percentage = item.Points > 0 ? (double)submission.Score.Value / item.Points * 100 : 0;
                                                    <span class="font-bold @(percentage >= 60 ? "text-green-600 dark:text-green-400" : "text-red-600 dark:text-red-400")">
                                                        @Math.Round(percentage, 1)%
                                                    </span>
                                                    <span class="text-xs text-gray-400">(@submission.Score/@item.Points)</span>
                                                }
                                                else
                                                {
                                                    <span>-</span>
                                                }
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <a asp-controller="Assignments" asp-action="Take" asp-route-id="@item.Id" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300">
                                                    @(submission != null ? "View" : "Start")
                                                </a>
                                            </td>
                                        }
                                        else
                                        {
                                            // Admin/Instructor View
                                            var submissionCount = (ViewBag.AllSubmissions as List<OzarkLMS.Models.Submission>)?.Count(s => s.AssignmentId == item.Id) ?? 0;
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-slate-400">
                                                @submissionCount Submissions
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                                <a asp-controller="Assignments" asp-action="Submissions" asp-route-id="@item.Id" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300">Grade</a>
                                                <a asp-controller="Assignments" asp-action="Edit" asp-route-id="@item.Id" class="text-gray-600 dark:text-slate-400 hover:text-gray-900 dark:hover:text-slate-200">Edit</a>
                                                <button type="button" onclick="openDeletionModal('@Url.Action("Delete", "Assignments", new { id = item.Id })', 'Delete Quiz', 'Are you sure you want to delete this quiz? This will also remove all student attempts.')" class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300">
                                                    <i data-lucide="trash-2" class="w-4 h-4 inline"></i>
                                                </button>
                                            </td>
                                        }
                                    </tr>
                                }
                                @if(!Model.Assignments.Any(a => a.Type == "quiz"))
                                {
                                    <tr>
                                        <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500 dark:text-slate-400">
                                            No quizzes found for this course.
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                     </div>
                 </div>
            }
            else if (activeTab == "meetings")
            {
                <div class="space-y-6">
                    <div class="pb-4 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-slate-800 dark:text-white">Course Meetings</h2>
                        @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                        {
                            <div class="flex space-x-2">
                                <a href="https://meet.google.com/new" target="_blank" class="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-lg font-bold text-sm shadow-sm hover:bg-gray-50 dark:hover:bg-slate-700 flex items-center transition-all">
                                    <i data-lucide="link" class="w-4 h-4 mr-2"></i> Get Meeting Link
                                </a>
                                <button onclick="document.getElementById('addMeetingForm').classList.toggle('hidden')" class="bg-[#004B87] dark:bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-md hover:bg-[#003d6e] dark:hover:bg-blue-700 flex items-center transition-all">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i> Add Meeting
                                </button>
                            </div>
                        }
                    </div>

                    @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                    {
                        <div id="addMeetingForm" class="hidden bg-gray-50 dark:bg-slate-800 p-6 rounded-xl border border-gray-200 dark:border-slate-700 mb-8 animation-slide-in">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-4">Add New Meeting</h3>
                            <form asp-action="AddMeeting" method="post" class="space-y-4">
                                <input type="hidden" name="courseId" value="@Model.Id" />
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="col-span-1 md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Meeting Name</label>
                                        <input type="text" name="name" required class="w-full px-4 py-2 rounded-lg border dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-[#004B87] outline-none" placeholder="Online Class - Week 5" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Start Time</label>
                                        <input type="datetime-local" name="startTime" required class="w-full px-4 py-2 rounded-lg border dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-[#004B87] outline-none" />
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">End Time</label>
                                        <input type="datetime-local" name="endTime" required class="w-full px-4 py-2 rounded-lg border dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-[#004B87] outline-none" />
                                    </div>
                                    <div class="col-span-1 md:col-span-2">
                                        <label class="block text-sm font-medium text-slate-600 dark:text-slate-400 mb-1">Meeting URL</label>
                                        <input type="url" name="url" required class="w-full px-4 py-2 rounded-lg border dark:border-slate-600 dark:bg-slate-700 dark:text-white focus:ring-2 focus:ring-[#004B87] outline-none" placeholder="https://meet.google.com/xxx-xxxx-xxx" />
                                    </div>
                                </div>
                                <div class="flex justify-end pt-2 space-x-2">
                                    <button type="button" onclick="document.getElementById('addMeetingForm').classList.add('hidden')" class="bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 text-slate-700 dark:text-slate-200 px-6 py-2 rounded-lg font-bold hover:bg-gray-50 dark:hover:bg-slate-600 transition-all">Cancel</button>
                                    <button type="submit" class="bg-[#004B87] dark:bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow-md hover:bg-[#003d6e] transition-all">Save Meeting</button>
                                </div>
                            </form>
                        </div>
                    }

                    <div class="grid grid-cols-1 gap-4">
                        @if(Model.Meetings != null && Model.Meetings.Any())
                        {
                            foreach(var meeting in Model.Meetings.OrderByDescending(m => m.StartTime))
                            {
                                <div class="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-xl p-5 flex flex-col md:flex-row items-center justify-between hover:shadow-md transition-all">
                                    <div class="flex items-center space-x-4 mb-4 md:mb-0">
                                        <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 text-[#004B87] dark:text-blue-300 flex items-center justify-center">
                                            <i data-lucide="video" class="w-6 h-6"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-slate-800 dark:text-white">@meeting.Name</h4>
                                            <div class="flex items-center text-xs text-slate-500 dark:text-slate-400 mt-1">
                                                <i data-lucide="calendar" class="w-3 h-3 mr-1"></i>
                                                <span>@meeting.StartTime.ToString("MMM dd, yyyy")</span>
                                                <span class="mx-2">•</span>
                                                <i data-lucide="clock" class="w-3 h-3 mr-1"></i>
                                                <span>@meeting.StartTime.ToString("h:mm tt") - @meeting.EndTime.ToString("h:mm tt")</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 w-full md:w-auto">
                                        <a href="@meeting.Url" target="_blank" class="flex-1 md:flex-none bg-[#004B87] dark:bg-blue-700 text-white px-8 py-2.5 rounded-lg font-bold text-center hover:bg-[#003d6e] dark:hover:bg-blue-800 transition-all shadow-sm">
                                            Join
                                        </a>
                                        @if (User.IsInRole("admin") || User.IsInRole("instructor"))
                                        {
                                            <button type="button" onclick="openDeleteMeetingModal(@meeting.Id)" class="p-2.5 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Delete Meeting">
                                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center py-20 border-2 border-dashed border-gray-100 dark:border-slate-700 rounded-xl bg-gray-50/50 dark:bg-slate-800/30">
                                <div class="w-16 h-16 bg-gray-100 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                                    <i data-lucide="video-off" class="w-8 h-8"></i>
                                </div>
                                <p class="text-slate-400 dark:text-slate-500 font-medium">No meetings scheduled for this course yet.</p>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                  @if (User.IsInRole("student") || (ViewBag.StudentSubmissions as List<OzarkLMS.Models.Submission>)?.Any() == true)
                  {
                      <div class="py-6">
                          <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Your Grades</h2>
                          
                          <div class="bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl overflow-hidden shadow-sm mb-6">
                              <div class="px-6 py-4 bg-gray-50 dark:bg-slate-800 border-b dark:border-slate-700 flex justify-between items-center">
                                  <span class="font-bold text-slate-600 dark:text-slate-300">Current Average</span>
                                  <span class="font-bold text-2xl text-[#004B87] dark:text-blue-400">@(ViewBag.CurrentGrade ?? 0)%</span>
                              </div>
                          </div>
                          
                          <div class="space-y-3">
                              @if(ViewBag.StudentSubmissions != null)
                              {
                                  foreach(var sub in (ViewBag.StudentSubmissions as List<OzarkLMS.Models.Submission>) ?? new List<OzarkLMS.Models.Submission>())
                                  {
                                      <div class="p-4 border dark:border-slate-700 rounded-lg flex justify-between items-center bg-white dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors">
                                          <div>
                                              <div class="font-bold text-slate-700 dark:text-slate-200">@(sub.Assignment?.Title ?? "Unknown Assignment")</div>
                                              <div class="text-xs text-slate-500 dark:text-slate-400">Submitted: @sub.SubmittedAt.ToShortDateString()</div>
                                          </div>
                                           <div class="font-bold @(sub.Assignment != null && sub.Score.HasValue && sub.Score >= (sub.Assignment.Points * 0.6) ? "text-green-600 dark:text-green-400" : (sub.Score.HasValue ? "text-red-500 dark:text-red-400" : "text-slate-500"))">
                                               @{
                                                   var percentage = (sub.Assignment != null && sub.Assignment.Points > 0 && sub.Score.HasValue) ? Math.Round((double)sub.Score.Value / sub.Assignment.Points * 100, 1) : 0;
                                               }
                                               @percentage% <span class="text-xs text-slate-400 font-normal">(@(sub.Score?.ToString() ?? "-")/@(sub.Assignment?.Points ?? 100))</span>
                                           </div>
                                      </div>
                                  }
                              }
                              else
                              {
                                  <div class="text-center text-slate-500 dark:text-slate-400 py-4">No grades available.</div>
                              }
                          </div>
                      </div>
                  }
                  else
                  {
                      <div class="py-6">
                          <h2 class="text-xl font-bold text-slate-800 dark:text-white mb-4">Class Gradebook</h2>
                          <div class="overflow-x-auto">
                              <table class="w-full text-left text-sm border-collapse">
                                  <thead>
                                      <tr class="bg-gray-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 border-b dark:border-slate-600">
                                          <th class="p-3">Student</th>
                                          @foreach(var assign in Model.Assignments)
                                          {
                                              <th class="p-3">@assign.Title</th>
                                          }
                                          <th class="p-3">Average</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      @if (Model.Enrollments != null)
                                      {
                                          foreach(var student in Model.Enrollments.Select(e => e.Student).Where(s => s != null))
                                          {
                                              var submissions = (ViewBag.AllSubmissions as List<OzarkLMS.Models.Submission>)?.Where(s => s.StudentId == student!.Id).ToList();
                                              double sum = 0;
                                              int count = 0;
                                              
                                              <tr class="border-b dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-800">
                                                  <td class="p-3 font-medium text-slate-700 dark:text-slate-300">@student!.Username</td>
                                                  @foreach(var assign in Model.Assignments)
                                                  {
                                                      var sub = submissions?.FirstOrDefault(s => s.AssignmentId == assign.Id);
                                                      <td class="p-3">
                                                          @if(sub != null && sub.Score.HasValue)
                                                          {
                                                              var percentage = assign.Points > 0 ? (double)sub.Score.Value / assign.Points * 100 : 0;
                                                              sum += percentage;
                                                              count++;
                                                              <span class="px-2 py-1 rounded bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400" title="@sub.Score / @assign.Points Points">
                                                                  @Math.Round(percentage, 0)%
                                                              </span>
                                                          }
                                                          else
                                                          {
                                                              <span class="text-gray-300 dark:text-slate-600">-</span>
                                                          }
                                                      </td>
                                                  }
                                                  <td class="p-3 font-bold text-[#004B87] dark:text-blue-400">
                                                      @(count > 0 ? Math.Round(sum / count, 1) : 0)%
                                                  </td>
                                              </tr>
                                          }
                                      }
                                  </tbody>
                              </table>
                          </div>
                      </div>
                  }
            }
        </main>
    </div>
</div>

<!-- Meeting Delete Confirmation Modal -->
<div id="deleteMeetingModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeDeleteMeetingModal()"></div>
    
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-slate-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-slate-100 dark:border-slate-700">
                <div class="p-6">
                    <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 dark:bg-red-900/30 rounded-full mb-4">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2" id="modal-title">Delete Meeting</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400">
                            Are you sure you want to delete this meeting? This action cannot be undone.
                        </p>
                    </div>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <form asp-action="DeleteMeeting" method="post" class="w-full sm:w-auto sm:ml-3">
                        <input type="hidden" id="deleteMeetingId" name="id" value="" />
                        <input type="hidden" name="courseId" value="@Model.Id" />
                        <button type="submit" class="inline-flex w-full justify-center rounded-xl bg-red-600 px-3 py-2 text-sm font-bold text-white shadow-sm hover:bg-red-500 sm:w-auto transition-colors">
                            Delete Meeting
                        </button>
                    </form>
                    <button type="button" onclick="closeDeleteMeetingModal()" class="mt-3 inline-flex w-full justify-center rounded-xl bg-white dark:bg-slate-800 px-3 py-2 text-sm font-bold text-slate-900 dark:text-slate-300 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 sm:mt-0 sm:w-auto transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Unified Deletion Confirmation Modal -->
<div id="deletionConfirmationModal" class="fixed inset-0 z-[60] hidden" aria-labelledby="deletion-modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeDeletionModal()"></div>
    
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white dark:bg-slate-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-md border border-slate-100 dark:border-slate-700">
                <div class="p-6">
                    <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 dark:bg-red-900/30 rounded-full mb-4">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600 dark:text-red-400"></i>
                    </div>
                    <div class="text-center">
                        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2" id="deletion-modal-title">Delete Content</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400" id="deletion-modal-message">
                            Are you sure you want to delete this content? This action cannot be undone.
                        </p>
                    </div>
                </div>
                <div class="bg-slate-50 dark:bg-slate-700/50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <form id="deletionConfirmationForm" method="post" class="w-full sm:w-auto sm:ml-3">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="inline-flex w-full justify-center rounded-xl bg-red-600 px-6 py-2 text-sm font-bold text-white shadow-sm hover:bg-red-500 sm:w-auto transition-colors">
                            Delete
                        </button>
                    </form>
                    <button type="button" onclick="closeDeletionModal()" class="mt-3 inline-flex w-full justify-center rounded-xl bg-white dark:bg-slate-800 px-6 py-2 text-sm font-bold text-slate-900 dark:text-slate-300 shadow-sm ring-1 ring-inset ring-slate-300 dark:ring-slate-600 hover:bg-slate-50 dark:hover:bg-slate-700 sm:mt-0 sm:w-auto transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openDeleteMeetingModal(id) {
        document.getElementById('deleteMeetingId').value = id;
        document.getElementById('deleteMeetingModal').classList.remove('hidden');
    }

    function closeDeleteMeetingModal() {
        document.getElementById('deleteMeetingModal').classList.add('hidden');
    }

    function openDeletionModal(url, title, message) {
        const modal = document.getElementById('deletionConfirmationModal');
        const form = document.getElementById('deletionConfirmationForm');
        const titleElem = document.getElementById('deletion-modal-title');
        const messageElem = document.getElementById('deletion-modal-message');

        form.action = url;
        titleElem.textContent = title;
        messageElem.textContent = message;

        modal.classList.remove('hidden');
    }

    function closeDeletionModal() {
        document.getElementById('deletionConfirmationModal').classList.add('hidden');
    }
</script>
